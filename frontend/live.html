<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BioRhythm X ‚Äî Live Health Monitor</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap"
        rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box
        }

        :root {
            --bg: #030712;
            --sidebar: #07101F;
            --card: #0B1827;
            --card2: #0F1E35;
            --teal: #00E5CC;
            --pink: #FF4C7A;
            --purple: #8B5CF6;
            --blue: #3B82F6;
            --orange: #F59E0B;
            --green: #22C55E;
            --red: #EF4444;
            --text: #F0F6FF;
            --muted: #7C8FAC;
            --border: rgba(255, 255, 255, 0.07)
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            display: flex
        }

        /* Sidebar */
        .sidebar {
            width: 240px;
            background: var(--sidebar);
            border-right: 1px solid var(--border);
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            padding: 0;
            display: flex;
            flex-direction: column
        }

        .sb-logo {
            padding: 22px 20px 20px;
            border-bottom: 1px solid var(--border);
            font-size: 17px;
            font-weight: 900
        }

        .sb-logo a {
            background: linear-gradient(135deg, var(--teal), var(--purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-decoration: none
        }

        .sb-section {
            padding: 8px 0;
            flex: 1
        }

        .sb-label {
            font-size: 10px;
            font-weight: 700;
            letter-spacing: 1.5px;
            color: var(--muted);
            padding: 14px 16px 6px;
            text-transform: uppercase
        }

        .sb-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 9px 16px;
            font-size: 13.5px;
            font-weight: 500;
            color: var(--muted);
            text-decoration: none;
            position: relative;
            transition: .15s
        }

        .sb-item:hover {
            background: rgba(255, 255, 255, .03);
            color: var(--text)
        }

        .sb-item.active {
            background: rgba(0, 229, 204, .07);
            color: var(--teal);
            font-weight: 600
        }

        .sb-item.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: var(--teal);
            border-radius: 0 2px 2px 0
        }

        .sb-bottom {
            border-top: 1px solid var(--border);
            padding: 14px 16px
        }

        .sb-device {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(0, 229, 204, .06);
            border: 1px solid rgba(0, 229, 204, .15);
            border-radius: 10px;
            padding: 10px 12px
        }

        .dev-dot {
            width: 7px;
            height: 7px;
            background: var(--green);
            border-radius: 50%;
            animation: pulse 1.2s infinite
        }

        @keyframes pulse {

            0%,
            100% {
                box-shadow: 0 0 0 0 rgba(34, 197, 94, .5)
            }

            70% {
                box-shadow: 0 0 0 5px rgba(34, 197, 94, 0)
            }
        }

        /* Main */
        .main {
            margin-left: 240px;
            flex: 1;
            padding: 0
        }

        .topbar {
            height: 66px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 32px;
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 40;
            background: rgba(3, 7, 18, .85);
            backdrop-filter: blur(20px)
        }

        .topbar h2 {
            font-size: 22px;
            font-weight: 800
        }

        .topbar p {
            font-size: 12px;
            color: var(--muted)
        }

        .content {
            padding: 28px 32px;
            max-width: 1400px
        }

        /* Layout */
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-bottom: 24px
        }

        .grid-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 24px
        }

        @media(max-width:1100px) {

            .grid-2,
            .grid-3 {
                grid-template-columns: 1fr
            }
        }

        /* Cards */
        .card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 24px;
            position: relative;
            overflow: hidden
        }

        .card-title {
            font-size: 15px;
            font-weight: 700;
            margin-bottom: 4px
        }

        .card-sub {
            font-size: 11px;
            color: var(--muted)
        }

        /* INPUT FORM */
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-top: 18px
        }

        .field label {
            display: block;
            font-size: 11px;
            font-weight: 600;
            color: var(--muted);
            margin-bottom: 5px;
            letter-spacing: .4px;
            text-transform: uppercase
        }

        .field input {
            width: 100%;
            padding: 11px 14px;
            background: rgba(255, 255, 255, .04);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 14px;
            font-family: inherit;
            outline: none;
            transition: .2s
        }

        .field input:focus {
            border-color: var(--teal);
            box-shadow: 0 0 0 3px rgba(0, 229, 204, .1)
        }

        .field input::placeholder {
            color: rgba(124, 143, 172, .4)
        }

        .field .unit {
            font-size: 10px;
            color: var(--muted);
            margin-top: 3px
        }

        .btn-submit {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, var(--teal), var(--purple));
            color: #000;
            font-size: 15px;
            font-weight: 800;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: .2s;
            font-family: inherit;
            margin-top: 10px;
            grid-column: 1/-1
        }

        .btn-submit:hover {
            opacity: .9;
            transform: translateY(-1px);
            box-shadow: 0 6px 24px rgba(0, 229, 204, .3)
        }

        .btn-submit:disabled {
            opacity: .5;
            cursor: not-allowed;
            transform: none
        }

        /* RISK GAUGE */
        .gauge-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px 0
        }

        .gauge-ring {
            width: 220px;
            height: 220px;
            border-radius: 50%;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center
        }

        .gauge-ring::before {
            content: '';
            position: absolute;
            inset: 8px;
            border-radius: 50%;
            background: var(--card)
        }

        .gauge-value {
            position: relative;
            z-index: 1;
            text-align: center
        }

        .gauge-num {
            font-size: 64px;
            font-weight: 900;
            line-height: 1
        }

        .gauge-pct {
            font-size: 18px;
            font-weight: 600;
            color: var(--muted)
        }

        .gauge-label {
            font-size: 14px;
            font-weight: 600;
            margin-top: 4px
        }

        /* Alert badge */
        .alert-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 24px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 700;
            margin-top: 16px
        }

        .alert-normal {
            background: rgba(34, 197, 94, .1);
            border: 1px solid rgba(34, 197, 94, .25);
            color: var(--green)
        }

        .alert-warning {
            background: rgba(245, 158, 11, .1);
            border: 1px solid rgba(245, 158, 11, .25);
            color: var(--orange)
        }

        .alert-critical {
            background: rgba(239, 68, 68, .12);
            border: 1px solid rgba(239, 68, 68, .3);
            color: var(--red);
            animation: flash .6s ease infinite
        }

        @keyframes flash {

            0%,
            100% {
                opacity: 1
            }

            50% {
                opacity: .7
            }
        }

        /* Risk History Chart */
        .chart-box {
            height: 180px;
            margin-top: 16px
        }

        .chart-box canvas {
            width: 100% !important;
            height: 100% !important
        }

        .chart-labels {
            display: flex;
            justify-content: space-between;
            font-size: 10px;
            color: var(--muted);
            margin-top: 4px
        }

        /* Log Table */
        .log-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
            margin-top: 12px
        }

        .log-table th {
            text-align: left;
            padding: 8px 10px;
            font-size: 10px;
            font-weight: 700;
            color: var(--muted);
            letter-spacing: 1px;
            text-transform: uppercase;
            border-bottom: 1px solid var(--border)
        }

        .log-table td {
            padding: 8px 10px;
            border-bottom: 1px solid rgba(255, 255, 255, .03)
        }

        .log-table tr:hover td {
            background: rgba(255, 255, 255, .02)
        }

        .sev {
            padding: 3px 10px;
            border-radius: 6px;
            font-size: 10px;
            font-weight: 700
        }

        /* Connection status */
        .conn-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            padding: 7px 14px;
            border-radius: 8px;
            border: 1px solid var(--border)
        }

        /* Audio alert */
        .hidden {
            display: none
        }
    </style>
</head>

<body>

    <aside class="sidebar">
        <div class="sb-logo"><a href="index.html">‚ö° BioRhythm X</a></div>
        <div class="sb-section">
            <div class="sb-label">Overview</div>
            <a class="sb-item" href="dashboard.html"><span>üìä</span> Dashboard</a>
            <a class="sb-item" href="analytics.html"><span>üìà</span> Analytics</a>
            <a class="sb-item active" href="live.html"><span>üî¥</span> Live Monitor</a>
            <div class="sb-label">Health</div>
            <a class="sb-item" href="dashboard.html"><span>‚ù§Ô∏è</span> Heart Rate</a>
            <a class="sb-item" href="dashboard.html"><span>ü´Ä</span> Blood Oxygen</a>
            <a class="sb-item" href="dashboard.html"><span>üòå</span> Stress</a>
            <div class="sb-label">Lifestyle</div>
            <a class="sb-item" href="activity.html"><span>üëü</span> Activity</a>
            <a class="sb-item" href="diet.html"><span>ü•ó</span> Nutrition</a>
            <div class="sb-label">System</div>
            <a class="sb-item" href="profile.html"><span>üë§</span> Profile</a>
        </div>
        <div class="sb-bottom">
            <div class="sb-device">
                <div class="dev-dot"></div>
                <div>
                    <div style="font-size:12px;font-weight:600">Da Fit Watch</div>
                    <div style="font-size:10px;color:var(--muted)">Manual / CSV input</div>
                </div>
            </div>
        </div>
    </aside>

    <div class="main">
        <div class="topbar">
            <div>
                <h2>üî¥ Live Health Monitor</h2>
                <p>Smartwatch ‚Üí LSTM ‚Üí Risk Score ‚Üí Alerts</p>
            </div>
            <div style="display:flex;gap:12px;align-items:center">
                <div class="conn-status" id="conn-status">
                    <div class="dev-dot"></div> <span id="conn-text">Ready</span>
                </div>
                <a href="dashboard.html"
                    style="padding:8px 14px;border:1px solid var(--border);border-radius:8px;color:var(--muted);text-decoration:none;font-size:13px">‚Üê
                    Dashboard</a>
            </div>
        </div>

        <div class="content">
            <div class="grid-2">

                <!-- INPUT FORM -->
                <div class="card">
                    <div class="card-title">üì° Health Data Input</div>
                    <div class="card-sub">Enter smartwatch readings or upload CSV from Da Fit app</div>

                    <form id="health-form" onsubmit="submitData(event)">
                        <div class="form-grid">
                            <div class="field">
                                <label>‚ù§Ô∏è Heart Rate</label>
                                <input type="number" id="in-hr" placeholder="72" value="72" step="1" min="30" max="220">
                                <div class="unit">BPM</div>
                            </div>
                            <div class="field">
                                <label>ü´Ä SpO2</label>
                                <input type="number" id="in-spo2" placeholder="98" value="98" step="0.1" min="70"
                                    max="100">
                                <div class="unit">%</div>
                            </div>
                            <div class="field">
                                <label>üå°Ô∏è Temperature</label>
                                <input type="number" id="in-temp" placeholder="36.5" value="36.5" step="0.1" min="33"
                                    max="42">
                                <div class="unit">¬∞C</div>
                            </div>
                            <div class="field">
                                <label>üåô Sleep Hours</label>
                                <input type="number" id="in-sleep" placeholder="7" value="7" step="0.5" min="0"
                                    max="14">
                                <div class="unit">hours last night</div>
                            </div>
                            <div class="field">
                                <label>üì° HRV (RMSSD)</label>
                                <input type="number" id="in-hrv" placeholder="55" value="55" step="1" min="5" max="150">
                                <div class="unit">ms</div>
                            </div>
                            <div class="field">
                                <label>üòå Respiration</label>
                                <input type="number" id="in-resp" placeholder="15" value="15" step="1" min="4" max="40">
                                <div class="unit">breaths/min</div>
                            </div>
                            <div class="field">
                                <label>üíâ BP Systolic</label>
                                <input type="number" id="in-bps" placeholder="120" value="120" step="1" min="80"
                                    max="200">
                                <div class="unit">mmHg</div>
                            </div>
                            <div class="field">
                                <label>üíâ BP Diastolic</label>
                                <input type="number" id="in-bpd" placeholder="78" value="78" step="1" min="50"
                                    max="130">
                                <div class="unit">mmHg</div>
                            </div>
                            <!-- Extra sensors -->
                            <div class="field">
                                <label>‚ö° ECG Signal</label>
                                <input type="number" id="in-ecg" placeholder="0.015" value="" step="0.001">
                                <div class="unit">mV (MLII / V5 / AVR)</div>
                            </div>
                            <div class="field">
                                <label>üíß GSR / EDA</label>
                                <input type="number" id="in-gsr" placeholder="2.0" value="" step="0.01">
                                <div class="unit">ŒºS (skin conductance)</div>
                            </div>
                            <div class="field">
                                <label>üìê Accel X</label>
                                <input type="number" id="in-ax" placeholder="0.01" value="" step="0.001">
                                <div class="unit">g (chest / wrist)</div>
                            </div>
                            <div class="field">
                                <label>üìê Accel Y</label>
                                <input type="number" id="in-ay" placeholder="0.98" value="" step="0.001">
                                <div class="unit">g</div>
                            </div>
                            <div class="field">
                                <label>üìê Accel Z</label>
                                <input type="number" id="in-az" placeholder="0.05" value="" step="0.001">
                                <div class="unit">g</div>
                            </div>
                            <div class="field">
                                <label>üèÉ Activity Label</label>
                                <input type="text" id="in-activity" placeholder="e.g. sitting, walking, running">
                                <div class="unit">from Da Fit / MHEALTH dataset</div>
                            </div>
                            <button type="submit" class="btn-submit" id="btn-submit">üöÄ Submit Data ‚Üí LSTM
                                Analysis</button>
                        </div>
                    </form>


                    <div style="margin-top:16px;padding-top:14px;border-top:1px solid var(--border)">
                        <div style="font-size:11px;color:var(--muted);font-weight:600;margin-bottom:8px">üìÅ OR UPLOAD
                            CSV (Da Fit export)</div>
                        <input type="file" id="csv-upload" accept=".csv" style="font-size:12px;color:var(--muted)"
                            onchange="uploadCSV(event)">
                    </div>
                </div>

                <!-- RISK GAUGE -->
                <div class="card" style="display:flex;flex-direction:column;align-items:center">
                    <div class="card-title" style="text-align:center">üß† LSTM Risk Analysis</div>
                    <div class="card-sub" style="text-align:center">Reconstruction error ‚Üí Risk Score</div>

                    <div class="gauge-container">
                        <div class="gauge-ring" id="gauge-ring"
                            style="background:conic-gradient(var(--green) 0deg, var(--green) 0deg, rgba(255,255,255,.06) 0deg)">
                            <div class="gauge-value">
                                <div class="gauge-num" id="risk-num" style="color:var(--green)">0</div>
                                <div class="gauge-pct">%</div>
                                <div class="gauge-label" id="risk-label">Waiting for data</div>
                            </div>
                        </div>
                    </div>

                    <div class="alert-badge alert-normal" id="alert-badge">‚úÖ Normal ‚Äî All vitals healthy</div>

                    <!-- Twilio call notification -->
                    <div id="call-banner"
                        style="display:none;margin-top:10px;padding:10px 16px;border-radius:10px;background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.3);font-size:12px;font-weight:600;color:#EF4444;width:100%;text-align:center;">
                    </div>

                    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;width:100%;margin-top:20px">
                        <div style="background:var(--card2);border-radius:10px;padding:12px;text-align:center">
                            <div style="font-size:10px;color:var(--muted)">Recon Error</div>
                            <div style="font-size:16px;font-weight:800;color:var(--teal)" id="recon-err">‚Äî</div>
                        </div>
                        <div style="background:var(--card2);border-radius:10px;padding:12px;text-align:center">
                            <div style="font-size:10px;color:var(--muted)">Submissions</div>
                            <div style="font-size:16px;font-weight:800;color:var(--blue)" id="sub-count">0</div>
                        </div>
                        <div style="background:var(--card2);border-radius:10px;padding:12px;text-align:center">
                            <div style="font-size:10px;color:var(--muted)">Anomalies</div>
                            <div style="font-size:16px;font-weight:800;color:var(--pink)" id="anomaly-count">0</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- BOTTOM: Chart + Log -->
            <div class="grid-2">
                <div class="card">
                    <div class="card-title">üìà Risk Score History</div>
                    <div class="card-sub">Live graph ‚Äî updates with each submission</div>
                    <div class="chart-box"><canvas id="risk-chart"></canvas></div>
                </div>
                <div class="card">
                    <div class="card-title">üìã Submission Log</div>
                    <div class="card-sub">Last 10 readings</div>
                    <div style="max-height:220px;overflow-y:auto">
                        <table class="log-table">
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>HR</th>
                                    <th>SpO‚ÇÇ</th>
                                    <th>Temp</th>
                                    <th>Risk</th>
                                    <th>Alert</th>
                                </tr>
                            </thead>
                            <tbody id="log-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Architecture banner -->
            <div class="card" style="margin-top:0">
                <div
                    style="font-size:12px;color:var(--muted);text-align:center;display:flex;align-items:center;justify-content:center;gap:16px;flex-wrap:wrap">
                    <span>‚åö Smartwatch</span>
                    <span style="color:var(--teal)">‚Üí</span>
                    <span>üì± Da Fit App</span>
                    <span style="color:var(--teal)">‚Üí</span>
                    <span>üì° Data Input</span>
                    <span style="color:var(--teal)">‚Üí</span>
                    <span style="color:var(--orange);font-weight:700">üß† LSTM Backend</span>
                    <span style="color:var(--teal)">‚Üí</span>
                    <span style="color:var(--pink);font-weight:700">‚ö†Ô∏è Risk Score</span>
                    <span style="color:var(--teal)">‚Üí</span>
                    <span style="color:var(--green);font-weight:700">üìä Dashboard</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ‚îÄ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        let riskHistory = [];
        let submissionCount = 0;
        let anomalyCount = 0;

        // API endpoint ‚Äî tries risk_server.py (5000) first, then main backend (8000)
        const API_URLS = ['http://localhost:5000/live-data', 'http://localhost:8000/api/live-data'];
        let apiUrl = API_URLS[0];

        // ‚îÄ‚îÄ‚îÄ Submit Data ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        async function submitData(e) {
            e.preventDefault();
            const btn = document.getElementById('btn-submit');
            btn.disabled = true;
            btn.textContent = '‚è≥ Analyzing...';
            document.getElementById('conn-text').textContent = 'Sending...';

            const data = {
                // Core vitals
                heart_rate: parseFloat(document.getElementById('in-hr').value),
                hr: parseFloat(document.getElementById('in-hr').value),
                spo2: parseFloat(document.getElementById('in-spo2').value),
                temperature: parseFloat(document.getElementById('in-temp').value),
                skin_temp: parseFloat(document.getElementById('in-temp').value),
                sleep_hours: parseFloat(document.getElementById('in-sleep').value),
                hrv_rmssd: parseFloat(document.getElementById('in-hrv').value),
                hrv: parseFloat(document.getElementById('in-hrv').value),
                respiration: parseFloat(document.getElementById('in-resp').value),
                resp: parseFloat(document.getElementById('in-resp').value),
                bp_systolic: parseFloat(document.getElementById('in-bps').value),
                bp_diastolic: parseFloat(document.getElementById('in-bpd').value),
                // Extended sensors
                ecg: parseFloat(document.getElementById('in-ecg').value) || null,
                mlii: parseFloat(document.getElementById('in-ecg').value) || null,
                gsr: parseFloat(document.getElementById('in-gsr').value) || null,
                eda: parseFloat(document.getElementById('in-gsr').value) || null,
                electrodermal: parseFloat(document.getElementById('in-gsr').value) || null,
                accel_x: parseFloat(document.getElementById('in-ax').value) || null,
                accel_y: parseFloat(document.getElementById('in-ay').value) || null,
                accel_z: parseFloat(document.getElementById('in-az').value) || null,
                acceleration_x: parseFloat(document.getElementById('in-ax').value) || null,
                acceleration_y: parseFloat(document.getElementById('in-ay').value) || null,
                acceleration_z: parseFloat(document.getElementById('in-az').value) || null,
                chest_acc_x: parseFloat(document.getElementById('in-ax').value) || null,
                chest_acc_y: parseFloat(document.getElementById('in-ay').value) || null,
                chest_acc_z: parseFloat(document.getElementById('in-az').value) || null,
                activity_label: document.getElementById('in-activity').value || 'unknown',
                activity: document.getElementById('in-activity').value || 'unknown',
            };

            let result;
            try {
                // Try each API URL
                for (const url of API_URLS) {
                    try {
                        const res = await fetch(url, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(data),
                        });
                        if (res.ok) {
                            result = await res.json();
                            apiUrl = url;
                            break;
                        }
                    } catch { continue; }
                }

                if (!result) {
                    // Fallback: client-side risk calculation
                    result = clientSideRisk(data);
                }

                updateUI(result, data);
                document.getElementById('conn-text').textContent = 'Connected ‚úì';
            } catch (err) {
                result = clientSideRisk(data);
                updateUI(result, data);
                document.getElementById('conn-text').textContent = 'Offline (local calc)';
            }

            btn.disabled = false;
            btn.textContent = 'üöÄ Submit Data ‚Üí LSTM Analysis';
        }

        // ‚îÄ‚îÄ‚îÄ Client-side risk fallback ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function clientSideRisk(d) {
            let risk = 0;
            if (d.heart_rate > 100) risk += (d.heart_rate - 100) * 1.5;
            if (d.heart_rate < 55) risk += (55 - d.heart_rate) * 1.2;
            if (d.spo2 < 95) risk += (95 - d.spo2) * 8;
            if (d.temperature > 37.5) risk += (d.temperature - 37.5) * 20;
            if (d.temperature < 35.5) risk += (35.5 - d.temperature) * 15;
            if (d.hrv_rmssd < 30) risk += (30 - d.hrv_rmssd) * 0.8;
            if (d.bp_systolic > 140) risk += (d.bp_systolic - 140) * 1.0;
            if (d.heart_rate > 85 && d.hrv_rmssd < 35) risk += 15;
            if (d.temperature > 37.2 && d.heart_rate > 90) risk += 20;
            if (d.spo2 < 95 && d.respiration > 20) risk += 25;
            risk = Math.max(0, Math.min(100, Math.round(risk)));
            return {
                risk_score: risk,
                alert_level: risk < 60 ? 'Normal' : risk < 80 ? 'Warning' : 'Critical',
                reconstruction_error: (risk / 100).toFixed(4),
            };
        }

        // ‚îÄ‚îÄ‚îÄ Update UI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function updateUI(result, data) {
            const risk = result.risk_score;
            const level = result.alert_level;

            // Gauge
            const deg = (risk / 100) * 360;
            const color = risk < 60 ? 'var(--green)' : risk < 80 ? 'var(--orange)' : 'var(--red)';
            document.getElementById('gauge-ring').style.background =
                `conic-gradient(${color} 0deg, ${color} ${deg}deg, rgba(255,255,255,.06) ${deg}deg)`;
            document.getElementById('risk-num').textContent = risk;
            document.getElementById('risk-num').style.color = color;
            document.getElementById('risk-label').textContent = level;

            // Alert badge
            const badge = document.getElementById('alert-badge');
            badge.className = 'alert-badge';
            if (level === 'Normal') {
                badge.classList.add('alert-normal');
                badge.innerHTML = '‚úÖ Normal ‚Äî All vitals healthy';
            } else if (level === 'Warning') {
                badge.classList.add('alert-warning');
                badge.innerHTML = '‚ö†Ô∏è Warning ‚Äî Risk elevated. Monitor closely.';
            } else {
                badge.classList.add('alert-critical');
                badge.innerHTML = 'üö® CRITICAL ‚Äî Immediate attention required! üìû Calling...';
                playAlertSound();
            }

            // Show Twilio call status
            const banner = document.getElementById('call-banner');
            if (level === 'Critical' && result.call_triggered) {
                const cr = result.call_triggered;
                if (cr.success) {
                    banner.style.display = 'block';
                    banner.style.background = 'rgba(34,197,94,.1)';
                    banner.style.borderColor = 'rgba(34,197,94,.3)';
                    banner.style.color = '#22C55E';
                    banner.innerHTML = `üìû TWILIO CALL INITIATED ‚Äî ${cr.message} (SID: ${cr.call_sid ? cr.call_sid.substr(0, 12) + '‚Ä¶' : '?'})`;
                } else {
                    banner.style.display = 'block';
                    banner.style.background = 'rgba(239,68,68,.1)';
                    banner.style.borderColor = 'rgba(239,68,68,.3)';
                    banner.style.color = '#EF4444';
                    banner.innerHTML = `üìû Call not sent: ${cr.message}`;
                }
                setTimeout(() => { banner.style.display = 'none'; }, 15000);
            } else if (level !== 'Critical') {
                banner.style.display = 'none';
            }

            // Stats
            submissionCount++;
            if (risk >= 60) anomalyCount++;
            document.getElementById('recon-err').textContent = result.reconstruction_error;
            document.getElementById('sub-count').textContent = submissionCount;
            document.getElementById('anomaly-count').textContent = anomalyCount;

            // History
            riskHistory.push(risk);
            if (riskHistory.length > 30) riskHistory.shift();
            drawRiskChart();

            // Log
            addLogRow(data, result);
        }

        // ‚îÄ‚îÄ‚îÄ Risk Chart ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function drawRiskChart() {
            const c = document.getElementById('risk-chart');
            if (!c) return;
            c.width = c.offsetWidth || 600;
            c.height = c.offsetHeight || 180;
            const ctx = c.getContext('2d');
            const W = c.width, H = c.height;
            ctx.clearRect(0, 0, W, H);

            // Zones
            ctx.fillStyle = 'rgba(34,197,94,0.05)';
            ctx.fillRect(0, H * 0.4, W, H * 0.6);
            ctx.fillStyle = 'rgba(245,158,11,0.05)';
            ctx.fillRect(0, H * 0.2, W, H * 0.2);
            ctx.fillStyle = 'rgba(239,68,68,0.05)';
            ctx.fillRect(0, 0, W, H * 0.2);

            // Threshold lines
            ctx.setLineDash([4, 4]);
            ctx.strokeStyle = 'rgba(245,158,11,0.3)';
            ctx.beginPath();
            ctx.moveTo(0, H * 0.4);
            ctx.lineTo(W, H * 0.4);
            ctx.stroke();
            ctx.strokeStyle = 'rgba(239,68,68,0.3)';
            ctx.beginPath();
            ctx.moveTo(0, H * 0.2);
            ctx.lineTo(W, H * 0.2);
            ctx.stroke();
            ctx.setLineDash([]);

            if (riskHistory.length < 2) return;

            // Line
            const pts = riskHistory.map((v, i) => ({
                x: (i / (riskHistory.length - 1)) * W,
                y: H - (v / 100) * H,
            }));

            ctx.beginPath();
            pts.forEach((p, i) => i ? ctx.lineTo(p.x, p.y) : ctx.moveTo(p.x, p.y));
            ctx.strokeStyle = '#00E5CC';
            ctx.lineWidth = 2.5;
            ctx.lineJoin = 'round';
            ctx.stroke();

            // Fill
            ctx.lineTo(W, H);
            ctx.lineTo(0, H);
            ctx.closePath();
            const g = ctx.createLinearGradient(0, 0, 0, H);
            g.addColorStop(0, '#00E5CC44');
            g.addColorStop(1, '#00E5CC00');
            ctx.fillStyle = g;
            ctx.fill();

            // Dots
            pts.forEach(p => {
                const risk = 100 - (p.y / H * 100);
                ctx.beginPath();
                ctx.arc(p.x, p.y, 4, 0, Math.PI * 2);
                ctx.fillStyle = risk < 60 ? '#22C55E' : risk < 80 ? '#F59E0B' : '#EF4444';
                ctx.fill();
            });
        }

        // ‚îÄ‚îÄ‚îÄ Log Table ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function addLogRow(data, result) {
            const tbody = document.getElementById('log-body');
            const time = new Date().toLocaleTimeString();
            const color = result.risk_score < 60 ? 'var(--green)' : result.risk_score < 80 ? 'var(--orange)' : 'var(--red)';
            const bgColor = result.risk_score < 60 ? 'rgba(34,197,94,.1)' : result.risk_score < 80 ? 'rgba(245,158,11,.1)' : 'rgba(239,68,68,.1)';
            const row = `<tr>
    <td>${time}</td>
    <td>${data.heart_rate}</td>
    <td>${data.spo2}</td>
    <td>${data.temperature}¬∞C</td>
    <td style="font-weight:700;color:${color}">${result.risk_score}%</td>
    <td><span class="sev" style="background:${bgColor};color:${color}">${result.alert_level}</span></td>
  </tr>`;
            tbody.insertAdjacentHTML('afterbegin', row);
            // Keep last 10
            while (tbody.children.length > 10) tbody.removeChild(tbody.lastChild);
        }

        // ‚îÄ‚îÄ‚îÄ CSV Upload ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function uploadCSV(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function (e) {
                const lines = e.target.result.split('\n');
                if (lines.length < 2) return;
                const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
                for (let i = 1; i < Math.min(lines.length, 20); i++) {
                    const vals = lines[i].split(',');
                    if (vals.length < headers.length) continue;
                    const row = {};
                    headers.forEach((h, j) => row[h] = vals[j]?.trim());
                    const data = {
                        heart_rate: parseFloat(row.heart_rate || row.hr || 72),
                        spo2: parseFloat(row.spo2 || row.blood_oxygen || 98),
                        temperature: parseFloat(row.temperature || row.temp || row.skin_temp || 36.5),
                        skin_temp: parseFloat(row.skin_temp || row.temperature || 36.5),
                        sleep_hours: parseFloat(row.sleep_hours || row.sleep || 7),
                        hrv_rmssd: parseFloat(row.hrv_rmssd || row.hrv || 55),
                        respiration: parseFloat(row.respiration || row.resp || 15),
                        bp_systolic: parseFloat(row.bp_systolic || row.bp_sys || 120),
                        bp_diastolic: parseFloat(row.bp_diastolic || row.bp_dia || 78),
                    };
                    const result = clientSideRisk(data);
                    setTimeout(() => updateUI(result, data), i * 300);
                }
            };
            reader.readAsText(file);
        }

        // ‚îÄ‚îÄ‚îÄ Alert Sound ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function playAlertSound() {
            try {
                const ctx = new AudioContext();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.frequency.value = 800;
                gain.gain.value = 0.3;
                osc.start();
                setTimeout(() => { osc.frequency.value = 600; }, 200);
                setTimeout(() => { osc.stop(); ctx.close(); }, 500);
            } catch { }
        }

        window.addEventListener('resize', drawRiskChart);
    </script>
</body>

</html>